import React, { useState, useEffect, createContext, useContext, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from 'firebase/firestore';

// --- Firebase Context ---
const FirebaseContext = createContext(null);

// Custom hook to use Firebase services
const useFirebase = () => useContext(FirebaseContext);

// --- Confirmation Modal Component ---
const ConfirmationModal = ({ isOpen, title, message, onConfirm, onCancel }) => {
    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm border-t-4 border-indigo-500 transform transition-all duration-300 scale-95 opacity-0 animate-scaleIn">
                <h3 className="text-xl font-bold text-indigo-700 mb-4">{title}</h3>
                <p className="text-gray-700 mb-6">{message}</p>
                <div className="flex justify-end space-x-3">
                    <button
                        onClick={onCancel}
                        className="px-5 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-100 transition duration-200"
                    >
                        Cancel
                    </button>
                    <button
                        onClick={onConfirm}
                        className="px-5 py-2 rounded-lg bg-indigo-600 text-white font-medium hover:bg-indigo-700 transition duration-300"
                    >
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    );
};

// --- Main App Component ---
function App() {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [currentPage, setCurrentPage] = useState('dashboard');
    const [message, setMessage] = useState({ text: '', type: '' });

    // Confirmation Modal States
    const [isConfirmModalOpen, setIsConfirmModalOpen] = useState(false);
    const [confirmModalDetails, setConfirmModalDetails] = useState({
        title: '', message: '', onConfirm: () => {},
    });

    // Firebase Initialization and Authentication
    useEffect(() => {
        const initializeFirebase = async () => {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                const app = initializeApp(firebaseConfig);
                const firestoreDb = getFirestore(app);
                const firebaseAuth = getAuth(app);

                setDb(firestoreDb);
                setAuth(firebaseAuth);

                const unsubscribe = onAuthStateChanged(firebaseAuth, async (user) => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        if (initialAuthToken) {
                            await signInWithCustomToken(firebaseAuth, initialAuthToken);
                        } else {
                            await signInAnonymously(firebaseAuth);
                        }
                    }
                    setIsAuthReady(true);
                });

                return () => unsubscribe();
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                setMessage({ text: `Error initializing Firebase: ${error.message}`, type: 'error' });
            }
        };

        initializeFirebase();
    }, []);

    const showMessage = useCallback((text, type = 'info') => {
        setMessage({ text, type });
        setTimeout(() => setMessage({ text: '', type: '' }), 3000);
    }, []);

    const showConfirm = useCallback((title, message, onConfirmCallback) => {
        setConfirmModalDetails({ title, message, onConfirm: onConfirmCallback });
        setIsConfirmModalOpen(true);
    }, []);

    const handleConfirmModalClose = useCallback(() => {
        setIsConfirmModalOpen(false);
        setConfirmModalDetails({ title: '', message: '', onConfirm: () => {} });
    }, []);

    const MessageBox = ({ message }) => {
        if (!message.text) return null;
        const bgColor = message.type === 'error' ? 'bg-red-500' : 'bg-green-500';
        return (
            <div className={`fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white ${bgColor}`}>
                {message.text}
            </div>
        );
    };

    if (!isAuthReady) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-100">
                <p className="text-gray-700 text-lg">Loading simulator...</p>
            </div>
        );
    }

    return (
        <FirebaseContext.Provider value={{ db, auth, userId, showMessage, showConfirm }}>
            <div className="min-h-screen bg-gradient-to-br from-blue-100 to-indigo-200 font-sans text-gray-800">
                <nav className="bg-white shadow-md p-4 rounded-b-xl">
                    <div className="container mx-auto flex justify-between items-center">
                        <h1 className="text-3xl font-bold text-indigo-700">üíä Pharmacy Simulator</h1>
                        <div className="flex space-x-4">
                            <button
                                onClick={() => setCurrentPage('dashboard')}
                                className={`px-4 py-2 rounded-lg font-medium transition duration-300 ${currentPage === 'dashboard' ? 'bg-indigo-600 text-white shadow-lg' : 'text-indigo-600 hover:bg-indigo-100'}`}
                            >
                                Dashboard
                            </button>
                            <button
                                onClick={() => setCurrentPage('inventory')}
                                className={`px-4 py-2 rounded-lg font-medium transition duration-300 ${currentPage === 'inventory' ? 'bg-indigo-600 text-white shadow-lg' : 'text-indigo-600 hover:bg-indigo-100'}`}
                            >
                                Inventory
                            </button>
                            <button
                                onClick={() => setCurrentPage('patients')}
                                className={`px-4 py-2 rounded-lg font-medium transition duration-300 ${currentPage === 'patients' ? 'bg-indigo-600 text-white shadow-lg' : 'text-indigo-600 hover:bg-indigo-100'}`}
                            >
                                Patients
                            </button>
                            <button
                                onClick={() => setCurrentPage('prescriptions')}
                                className={`px-4 py-2 rounded-lg font-medium transition duration-300 ${currentPage === 'prescriptions' ? 'bg-indigo-600 text-white shadow-lg' : 'text-indigo-600 hover:bg-indigo-100'}`}
                            >
                                Prescriptions
                            </button>
                            <button
                                onClick={() => setCurrentPage('billing')}
                                className={`px-4 py-2 rounded-lg font-medium transition duration-300 ${currentPage === 'billing' ? 'bg-indigo-600 text-white shadow-lg' : 'text-indigo-600 hover:bg-indigo-100'}`}
                            >
                                Billing & Payments
                            </button>
                            <button
                                onClick={() => setCurrentPage('trainingModules')}
                                className={`px-4 py-2 rounded-lg font-medium transition duration-300 ${currentPage === 'trainingModules' ? 'bg-indigo-600 text-white shadow-lg' : 'text-indigo-600 hover:bg-indigo-100'}`}
                            >
                                Training Modules
                            </button>
                        </div>
                    </div>
                </nav>

                <main className="container mx-auto p-6">
                    {currentPage === 'dashboard' && <Dashboard />}
                    {currentPage === 'inventory' && <InventoryManagement />}
                    {currentPage === 'patients' && <PatientManagement />}
                    {currentPage === 'prescriptions' && <PrescriptionManagement />}
                    {currentPage === 'billing' && <BillingAndPayments />}
                    {currentPage === 'trainingModules' && <TrainingModules />}
                </main>
                <MessageBox message={message} />
                <ConfirmationModal
                    isOpen={isConfirmModalOpen}
                    title={confirmModalDetails.title}
                    message={confirmModalDetails.message}
                    onConfirm={() => { confirmModalDetails.onConfirm(); handleConfirmModalClose(); }}
                    onCancel={handleConfirmModalClose}
                />
            </div>
        </FirebaseContext.Provider>
    );
}

// --- Dashboard Component ---
const Dashboard = () => {
    const { db, userId } = useFirebase();
    const [medications, setMedications] = useState([]);
    const [patients, setPatients] = useState([]);
    const [prescriptions, setPrescriptions] = useState([]);
    const [transactions, setTransactions] = useState([]);

    useEffect(() => {
        if (!db || !userId) return;

        // Fetch medications
        const medCollectionRef = collection(db, `artifacts/${userId}/users/${userId}/medications`);
        const unsubscribeMeds = onSnapshot(medCollectionRef, (snapshot) => {
            const medsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setMedications(medsData);
        }, (error) => console.error("Error fetching medications:", error));

        // Fetch patients
        const patientCollectionRef = collection(db, `artifacts/${userId}/users/${userId}/patients`);
        const unsubscribePatients = onSnapshot(patientCollectionRef, (snapshot) => {
            const patientsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setPatients(patientsData);
        }, (error) => console.error("Error fetching patients:", error));

        // Fetch prescriptions
        const prescriptionCollectionRef = collection(db, `artifacts/${userId}/users/${userId}/prescriptions`);
        const unsubscribePrescriptions = onSnapshot(prescriptionCollectionRef, async (snapshot) => {
            const rxData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            // Enrich with patient and medication names for dashboard display
            const enrichedRx = await Promise.all(rxData.map(async (rx) => {
                let patientName = 'Unknown Patient';
                let medicationName = 'Unknown Medication';

                if (rx.patientId) {
                    const patientDocRef = doc(db, `artifacts/${userId}/users/${userId}/patients`, rx.patientId);
                    const patientSnap = await getDoc(patientDocRef);
                    if (patientSnap.exists()) {
                        patientName = patientSnap.data().name;
                    }
                }

                if (rx.medicationId) {
                    const medDocRef = doc(db, `artifacts/${userId}/users/${userId}/medications`, rx.medicationId);
                    const medSnap = await getDoc(medDocRef);
                    if (medSnap.exists()) {
                        medicationName = medSnap.data().name;
                    }
                }
                return { ...rx, patientName, medicationName };
            }));
            setPrescriptions(enrichedRx);
        }, (error) => console.error("Error fetching prescriptions:", error));

        // Fetch transactions
        const transactionCollectionRef = collection(db, `artifacts/${userId}/users/${userId}/transactions`);
        const unsubscribeTransactions = onSnapshot(transactionCollectionRef, (snapshot) => {
            const transactionsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setTransactions(transactionsData);
        }, (error) => console.error("Error fetching transactions:", error));


        return () => {
            unsubscribeMeds();
            unsubscribePatients();
            unsubscribePrescriptions();
            unsubscribeTransactions();
        };
    }, [db, userId]);

    const lowStockMeds = medications.filter(med => med.stock < 10);
    const pendingPrescriptions = prescriptions.filter(rx => rx.status === 'Pending');
    const unpaidBills = transactions.filter(t => t.balance > 0);
    const totalRevenue = transactions.reduce((sum, t) => sum + (t.amountPaid || 0), 0);


    return (
        <div className="bg-white p-8 rounded-xl shadow-lg">
            <h2 className="text-3xl font-bold text-indigo-700 mb-6 border-b-2 border-indigo-200 pb-2">üìä Dashboard</h2>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div className="bg-blue-50 p-6 rounded-lg shadow-md flex items-center space-x-4">
                    <span className="text-4xl text-blue-600">üì¶</span>
                    <div>
                        <p className="text-gray-600">Total Medications</p>
                        <p className="text-3xl font-bold text-blue-700">{medications.length}</p>
                    </div>
                </div>
                <div className="bg-green-50 p-6 rounded-lg shadow-md flex items-center space-x-4">
                    <span className="text-4xl text-green-600">üßë‚Äçü§ù‚Äçüßë</span>
                    <div>
                        <p className="text-gray-600">Total Patients</p>
                        <p className="text-3xl font-bold text-green-700">{patients.length}</p>
                    </div>
                </div>
                <div className="bg-purple-50 p-6 rounded-lg shadow-md flex items-center space-x-4">
                    <span className="text-4xl text-purple-600">üìù</span>
                    <div>
                        <p className="text-gray-600">Total Prescriptions</p>
                        <p className="text-3xl font-bold text-purple-700">{prescriptions.length}</p>
                    </div>
                </div>
                <div className="bg-teal-50 p-6 rounded-lg shadow-md flex items-center space-x-4">
                    <span className="text-4xl text-teal-600">üí∏</span>
                    <div>
                        <p className="text-gray-600">Total Revenue</p>
                        <p className="text-3xl font-bold text-teal-700">${totalRevenue.toFixed(2)}</p>
                    </div>
                </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="bg-yellow-50 p-6 rounded-lg shadow-md">
                    <h3 className="text-xl font-semibold text-yellow-700 mb-4">‚ö†Ô∏è Low Stock Medications ({lowStockMeds.length})</h3>
                    {lowStockMeds.length === 0 ? (
                        <p className="text-gray-600">No medications are currently low on stock. Great job!</p>
                    ) : (
                        <ul className="list-disc list-inside text-gray-700">
                            {lowStockMeds.map(med => (
                                <li key={med.id}>{med.name} - Stock: {med.stock}</li>
                            ))}
                        </ul>
                    )}
                </div>

                <div className="bg-red-50 p-6 rounded-lg shadow-md">
                    <h3 className="text-xl font-semibold text-red-700 mb-4">‚è≥ Pending Prescriptions ({pendingPrescriptions.length})</h3>
                    {pendingPrescriptions.length === 0 ? (
                        <p className="text-gray-600">No prescriptions are currently pending. All caught up!</p>
                    ) : (
                        <ul className="list-disc list-inside text-gray-700">
                            {pendingPrescriptions.map(rx => (
                                <li key={rx.id}>
                                    {rx.patientName} - {rx.medicationName} ({rx.quantity} units)
                                </li>
                            ))}
                        </ul>
                    )}
                </div>

                <div className="bg-orange-50 p-6 rounded-lg shadow-md col-span-full">
                    <h3 className="text-xl font-semibold text-orange-700 mb-4">üí∞ Unpaid Bills ({unpaidBills.length})</h3>
                    {unpaidBills.length === 0 ? (
                        <p className="text-gray-600">No outstanding bills. Fantastic!</p>
                    ) : (
                        <ul className="list-disc list-inside text-gray-700">
                            {unpaidBills.map(bill => (
                                <li key={bill.id}>
                                    Bill ID: {bill.id.substring(0, 8)}... - Patient: {bill.patientName} - Amount Due: ${bill.balance.toFixed(2)}
                                </li>
                            ))}
                        </ul>
                    )}
                </div>
            </div>

            <p className="text-gray-500 text-sm mt-8 text-right">
                Your User ID: <span className="font-mono text-xs text-indigo-500">{userId}</span>
            </p>
        </div>
    );
};


// --- Inventory Management Component ---
const InventoryManagement = () => {
    const { db, userId, showMessage, showConfirm } = useFirebase();
    const [medications, setMedications] = useState([]);
    const [formData, setFormData] = useState({
        name: '', strength: '', dosageForm: '', stock: '', price: '', manufacturer: '', ndc: '', expirationDate: ''
    });
    const [editId, setEditId] = useState(null);
    const [searchTerm, setSearchTerm] = useState('');
    const [sortConfig, setSortConfig] = useState({ key: null, direction: 'ascending' });

    useEffect(() => {
        if (!db || !userId) return;

        const medsCollectionRef = collection(db, `artifacts/${userId}/users/${userId}/medications`);
        const unsubscribe = onSnapshot(medsCollectionRef, (snapshot) => {
            const medsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setMedications(medsData);
        }, (error) => {
            console.error("Error fetching medications:", error);
            showMessage(`Error fetching medications: ${error.message}`, 'error');
        });

        return () => unsubscribe();
    }, [db, userId, showMessage]);

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData({ ...formData, [name]: value });
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!db || !userId) {
            showMessage("Database not ready. Please try again.", 'error');
            return;
        }

        try {
            const medsCollectionRef = collection(db, `artifacts/${userId}/users/${userId}/medications`);
            if (editId) {
                const medDocRef = doc(db, medsCollectionRef.path, editId);
                await updateDoc(medDocRef, {
                    ...formData,
                    stock: parseInt(formData.stock, 10),
                    price: parseFloat(formData.price),
                });
                showMessage("Medication updated successfully!", 'success');
            } else {
                await addDoc(medsCollectionRef, {
                    ...formData,
                    stock: parseInt(formData.stock, 10),
                    price: parseFloat(formData.price),
                    createdAt: new Date(),
                });
                showMessage("Medication added successfully!", 'success');
            }
            setFormData({ name: '', strength: '', dosageForm: '', stock: '', price: '', manufacturer: '', ndc: '', expirationDate: '' });
            setEditId(null);
        } catch (error) {
            console.error("Error saving medication:", error);
            showMessage(`Error saving medication: ${error.message}`, 'error');
        }
    };

    const handleEdit = (med) => {
        setFormData({
            name: med.name || '',
            strength: med.strength || '',
            dosageForm: med.dosageForm || '',
            stock: String(med.stock) || '',
            price: String(med.price) || '',
            manufacturer: med.manufacturer || '',
            ndc: med.ndc || '',
            expirationDate: med.expirationDate || '',
        });
        setEditId(med.id);
    };

    const handleDelete = async (id) => {
        if (!db || !userId) return;
        showConfirm(
            "Confirm Delete",
            "Are you sure you want to delete this medication? This action cannot be undone.",
            async () => {
                try {
                    const medDocRef = doc(db, `artifacts/${userId}/users/${userId}/medications`, id);
                    await deleteDoc(medDocRef);
                    showMessage("Medication deleted successfully!", 'success');
                } catch (error) {
                    console.error("Error deleting medication:", error);
                    showMessage(`Error deleting medication: ${error.message}`, 'error');
                }
            }
        );
    };

    const handleSort = (key) => {
        let direction = 'ascending';
        if (sortConfig.key === key && sortConfig.direction === 'ascending') {
            direction = 'descending';
        } else if (sortConfig.key === key && sortConfig.direction === 'descending') {
            direction = null; // No sort
            key = null;
        }
        setSortConfig({ key, direction });
    };

    const sortedAndFilteredMedications = [...medications]
        .filter(med =>
            (med.name || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (med.strength || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (med.dosageForm || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (med.manufacturer || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (med.ndc || '').toLowerCase().includes(searchTerm.toLowerCase())
        )
        .sort((a, b) => {
            if (sortConfig.key) {
                const aValue = a[sortConfig.key];
                const bValue = b[sortConfig.key];

                if (aValue === undefined || bValue === undefined || aValue === null || bValue === null) return 0; // Handle missing/null keys

                if (typeof aValue === 'string' && typeof bValue === 'string') {
                    return sortConfig.direction === 'ascending'
                        ? aValue.localeCompare(bValue)
                        : bValue.localeCompare(aValue);
                } else if (typeof aValue === 'number' && typeof bValue === 'number') {
                    return sortConfig.direction === 'ascending'
                        ? aValue - bValue
                        : bValue - aValue;
                }
            }
            return 0;
        });

    const getSortIndicator = (key) => {
        if (sortConfig.key !== key) return '';
        return sortConfig.direction === 'ascending' ? ' ‚ñ≤' : ' ‚ñº';
    };


    return (
        <div className="bg-white p-8 rounded-xl shadow-lg">
            <h2 className="text-3xl font-bold text-indigo-700 mb-6 border-b-2 border-indigo-200 pb-2">üì¶ Inventory Management</h2>

            <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8 p-6 bg-indigo-50 rounded-lg shadow-inner">
                <div className="flex flex-col">
                    <label htmlFor="name" className="text-gray-700 font-medium mb-1">Medication Name:</label>
                    <input
                        type="text" id="name" name="name"
                        value={formData.name} onChange={handleChange}
                        className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400"
                        placeholder="e.g., Ibuprofen" required
                    />
                </div>
                <div className="flex flex-col">
                    <label htmlFor="strength" className="text-gray-700 font-medium mb-1">Strength:</label>
                    <input
                        type="text" id="strength" name="strength"
                        value={formData.strength} onChange={handleChange}
                        className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400"
                        placeholder="e.g., 200mg" required
                    />
                </div>
                <div className="flex flex-col">
                    <label htmlFor="dosageForm" className="text-gray-700 font-medium mb-1">Dosage Form:</label>
                    <input
                        type="text" id="dosageForm" name="dosageForm"
                        value={formData.dosageForm} onChange={handleChange}
                        className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400"
                        placeholder="e.g., Tablet" required
                    />
                </div>
                <div className="flex flex-col">
                    <label htmlFor="stock" className="text-gray-700 font-medium mb-1">Stock Quantity:</label>
                    <input
                        type="number" id="stock" name="stock"
                        value={formData.stock} onChange={handleChange}
                        className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400"
                        placeholder="e.g., 100" min="0" required
                    />
                </div>
                <div className="flex flex-col">
                    <label htmlFor="price" className="text-gray-700 font-medium mb-1">Price per unit ($):</label>
                    <input
                        type="number" id="price" name="price"
                        value={formData.price} onChange={handleChange}
                        className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400"
                        placeholder="e.g., 5.99" step="0.01" min="0" required
                    />
                </div>
                <div className="flex flex-col">
                    <label htmlFor="manufacturer" className="text-gray-700 font-medium mb-1">Manufacturer:</label>
                    <input
                        type="text" id="manufacturer" name="manufacturer"
                        value={formData.manufacturer} onChange={handleChange}
                        className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400"
                        placeholder="e.g., Pfizer"
                    />
                </div>
                <div className="flex flex-col">
                    <label htmlFor="ndc" className="text-gray-700 font-medium mb-1">NDC (National Drug Code):</label>
                    <input
                        type="text" id="ndc" name="ndc"
                        value={formData.ndc} onChange={handleChange}
                        className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400"
                        placeholder="e.g., 00002-8000-01"
                    />
                </div>
                <div className="flex flex-col">
                    <label htmlFor="expirationDate" className="text-gray-700 font-medium mb-1">Expiration Date:</label>
                    <input
                        type="date" id="expirationDate" name="expirationDate"
                        value={formData.expirationDate} onChange={handleChange}
                        className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400"
                    />
                </div>
                <div className="col-span-full flex justify-end mt-4">
                    <button
                        type="submit"
                        className="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-indigo-700 transition duration-300 transform hover:scale-105"
                    >
                        {editId ? 'Update Medication' : 'Add Medication'}
                    </button>
                    {editId && (
                        <button
                            type="button"
                            onClick={() => { setEditId(null); setFormData({ name: '', strength: '', dosageForm: '', stock: '', price: '', manufacturer: '', ndc: '', expirationDate: '' }); }}
                            className="ml-4 bg-gray-400 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-gray-500 transition duration-300 transform hover:scale-105"
                        >
                            Cancel Edit
                        </button>
                    )}
                </div>
            </form>

            <h3 className="text-2xl font-semibold text-indigo-600 mb-4">Current Inventory</h3>
            <div className="mb-4">
                <input
                    type="text"
                    placeholder="Search medications..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="p-2 border border-gray-300 rounded-lg w-full md:w-1/2 focus:outline-none focus:ring-2 focus:ring-indigo-400"
                />
            </div>
            {medications.length === 0 ? (
                <p className="text-gray-600">No medications in inventory yet. Add some above!</p>
            ) : (
                <div className="overflow-x-auto rounded-lg shadow-md border border-gray-200">
                    <table className="min-w-full bg-white">
                        <thead className="bg-gray-100 border-b border-gray-200">
                            <tr>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase cursor-pointer" onClick={() => handleSort('name')}>
                                    Name {getSortIndicator('name')}
                                </th>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase cursor-pointer" onClick={() => handleSort('strength')}>
                                    Strength {getSortIndicator('strength')}
                                </th>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase cursor-pointer" onClick={() => handleSort('dosageForm')}>
                                    Form {getSortIndicator('dosageForm')}
                                </th>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase cursor-pointer" onClick={() => handleSort('stock')}>
                                    Stock {getSortIndicator('stock')}
                                </th>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase cursor-pointer" onClick={() => handleSort('price')}>
                                    Price {getSortIndicator('price')}
                                </th>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase cursor-pointer" onClick={() => handleSort('manufacturer')}>
                                    Manufacturer {getSortIndicator('manufacturer')}
                                </th>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase cursor-pointer" onClick={() => handleSort('ndc')}>
                                    NDC {getSortIndicator('ndc')}
                                </th>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase cursor-pointer" onClick={() => handleSort('expirationDate')}>
                                    Exp. Date {getSortIndicator('expirationDate')}
                                </th>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {sortedAndFilteredMedications.map((med) => (
                                <tr key={med.id} className="border-b border-gray-200 hover:bg-gray-50">
                                    <td className="py-3 px-4 text-gray-800">{med.name}</td>
                                    <td className="py-3 px-4 text-gray-800">{med.strength}</td>
                                    <td className="py-3 px-4 text-gray-800">{med.dosageForm}</td>
                                    <td className="py-3 px-4 text-gray-800">{med.stock}</td>
                                    <td className="py-3 px-4 text-gray-800">${med.price ? med.price.toFixed(2) : '0.00'}</td>
                                    <td className="py-3 px-4 text-gray-800">{med.manufacturer}</td>
                                    <td className="py-3 px-4 text-gray-800">{med.ndc}</td>
                                    <td className="py-3 px-4 text-gray-800">{med.expirationDate}</td>
                                    <td className="py-3 px-4 flex space-x-2">
                                        <button
                                            onClick={() => handleEdit(med)}
                                            className="bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600 transition duration-200"
                                        >
                                            Edit
                                        </button>
                                        <button
                                            onClick={() => handleDelete(med.id)}
                                            className="bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600 transition duration-200"
                                        >
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
        </div>
    );
};

// --- Patient Management Component ---
const PatientManagement = () => {
    const { db, userId, showMessage, showConfirm } = useFirebase();
    const [patients, setPatients] = useState([]);
    const [formData, setFormData] = useState({
        name: '', dob: '', contact: '', address: '', allergies: '', medicalConditions: ''
    });
    const [editId, setEditId] = useState(null);
    const [searchTerm, setSearchTerm] = useState('');
    const [sortConfig, setSortConfig] = useState({ key: null, direction: 'ascending' });

    useEffect(() => {
        if (!db || !userId) return;

        const patientCollectionRef = collection(db, `artifacts/${userId}/users/${userId}/patients`);
        const unsubscribe = onSnapshot(patientCollectionRef, (snapshot) => {
            const patientsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setPatients(patientsData);
        }, (error) => {
            console.error("Error fetching patients:", error);
            showMessage(`Error fetching patients: ${error.message}`, 'error');
        });

        return () => unsubscribe();
    }, [db, userId, showMessage]);

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData({ ...formData, [name]: value });
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!db || !userId) {
            showMessage("Database not ready. Please try again.", 'error');
            return;
        }

        try {
            const patientCollectionRef = collection(db, `artifacts/${userId}/users/${userId}/patients`);
            if (editId) {
                const patientDocRef = doc(db, patientCollectionRef.path, editId);
                await updateDoc(patientDocRef, formData);
                showMessage("Patient updated successfully!", 'success');
            } else {
                await addDoc(patientCollectionRef, { ...formData, createdAt: new Date() });
                showMessage("Patient added successfully!", 'success');
            }
            setFormData({ name: '', dob: '', contact: '', address: '', allergies: '', medicalConditions: '' });
            setEditId(null);
        } catch (error) {
            console.error("Error saving patient:", error);
            showMessage(`Error saving patient: ${error.message}`, 'error');
        }
    };

    const handleEdit = (patient) => {
        setFormData({
            name: patient.name || '',
            dob: patient.dob || '',
            contact: patient.contact || '',
            address: patient.address || '',
            allergies: patient.allergies || '',
            medicalConditions: patient.medicalConditions || '',
        });
        setEditId(patient.id);
    };

    const handleDelete = async (id) => {
        if (!db || !userId) return;
        showConfirm(
            "Confirm Delete",
            "Are you sure you want to delete this patient? This action cannot be undone.",
            async () => {
                try {
                    const patientDocRef = doc(db, `artifacts/${userId}/users/${userId}/patients`, id);
                    await deleteDoc(patientDocRef);
                    showMessage("Patient deleted successfully!", 'success');
                } catch (error) {
                    console.error("Error deleting patient:", error);
                    showMessage(`Error deleting patient: ${error.message}`, 'error');
                }
            }
        );
    };

    const handleSort = (key) => {
        let direction = 'ascending';
        if (sortConfig.key === key && sortConfig.direction === 'ascending') {
            direction = 'descending';
        } else if (sortConfig.key === key && sortConfig.direction === 'descending') {
            direction = null; // No sort
            key = null;
        }
        setSortConfig({ key, direction });
    };

    const sortedAndFilteredPatients = [...patients]
        .filter(patient =>
            (patient.name || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (patient.contact || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (patient.address || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (patient.allergies || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (patient.medicalConditions || '').toLowerCase().includes(searchTerm.toLowerCase())
        )
        .sort((a, b) => {
            if (sortConfig.key) {
                const aValue = a[sortConfig.key];
                const bValue = b[sortConfig.key];

                if (aValue === undefined || bValue === undefined || aValue === null || bValue === null) return 0;

                if (typeof aValue === 'string' && typeof bValue === 'string') {
                    return sortConfig.direction === 'ascending'
                        ? aValue.localeCompare(bValue)
                        : bValue.localeCompare(aValue);
                } else {
                    return sortConfig.direction === 'ascending'
                        ? aValue - bValue
                        : bValue - aValue;
                }
            }
            return 0;
        });

    const getSortIndicator = (key) => {
        if (sortConfig.key !== key) return '';
        return sortConfig.direction === 'ascending' ? ' ‚ñ≤' : ' ‚ñº';
    };


    return (
        <div className="bg-white p-8 rounded-xl shadow-lg">
            <h2 className="text-3xl font-bold text-indigo-700 mb-6 border-b-2 border-indigo-200 pb-2">üßë‚Äçü§ù‚Äçüßë Patient Management</h2>

            <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8 p-6 bg-indigo-50 rounded-lg shadow-inner">
                <div className="flex flex-col">
                    <label htmlFor="patientName" className="text-gray-700 font-medium mb-1">Patient Name:</label>
                    <input
                        type="text" id="patientName" name="name"
                        value={formData.name} onChange={handleChange}
                        className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400"
                        placeholder="e.g., John Doe" required
                    />
                </div>
                <div className="flex flex-col">
                    <label htmlFor="dob" className="text-gray-700 font-medium mb-1">Date of Birth:</label>
                    <input
                        type="date" id="dob" name="dob"
                        value={formData.dob} onChange={handleChange}
                        className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400"
                        required
                    />
                </div>
                <div className="flex flex-col">
                    <label htmlFor="contact" className="text-gray-700 font-medium mb-1">Contact Info:</label>
                    <input
                        type="text" id="contact" name="contact"
                        value={formData.contact} onChange={handleChange}
                        className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400"
                        placeholder="e.g., 555-123-4567 or email@example.com" required
                    />
                </div>
                <div className="flex flex-col">
                    <label htmlFor="address" className="text-gray-700 font-medium mb-1">Address:</label>
                    <input
                        type="text" id="address" name="address"
                        value={formData.address} onChange={handleChange}
                        className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400"
                        placeholder="e.g., 123 Main St, Anytown"
                    />
                </div>
                <div className="flex flex-col">
                    <label htmlFor="allergies" className="text-gray-700 font-medium mb-1">Allergies:</label>
                    <input
                        type="text" id="allergies" name="allergies"
                        value={formData.allergies} onChange={handleChange}
                        className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400"
                        placeholder="e.g., Penicillin, Peanuts (comma-separated)"
                    />
                </div>
                <div className="flex flex-col">
                    <label htmlFor="medicalConditions" className="text-gray-700 font-medium mb-1">Medical Conditions:</label>
                    <input
                        type="text" id="medicalConditions" name="medicalConditions"
                        value={formData.medicalConditions} onChange={handleChange}
                        className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400"
                        placeholder="e.g., Diabetes, Hypertension (comma-separated)"
                    />
                </div>
                <div className="col-span-full flex justify-end mt-4">
                    <button
                        type="submit"
                        className="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-indigo-700 transition duration-300 transform hover:scale-105"
                    >
                        {editId ? 'Update Patient' : 'Add Patient'}
                    </button>
                    {editId && (
                        <button
                            type="button"
                            onClick={() => { setEditId(null); setFormData({ name: '', dob: '', contact: '', address: '', allergies: '', medicalConditions: '' }); }}
                            className="ml-4 bg-gray-400 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-gray-500 transition duration-300 transform hover:scale-105"
                        >
                            Cancel Edit
                        </button>
                    )}
                </div>
            </form>

            <h3 className="text-2xl font-semibold text-indigo-600 mb-4">Registered Patients</h3>
            <div className="mb-4">
                <input
                    type="text"
                    placeholder="Search patients..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="p-2 border border-gray-300 rounded-lg w-full md:w-1/2 focus:outline-none focus:ring-2 focus:ring-indigo-400"
                />
            </div>
            {patients.length === 0 ? (
                <p className="text-gray-600">No patients registered yet. Add some above!</p>
            ) : (
                <div className="overflow-x-auto rounded-lg shadow-md border border-gray-200">
                    <table className="min-w-full bg-white">
                        <thead className="bg-gray-100 border-b border-gray-200">
                            <tr>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase cursor-pointer" onClick={() => handleSort('name')}>
                                    Name {getSortIndicator('name')}
                                </th>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase cursor-pointer" onClick={() => handleSort('dob')}>
                                    Date of Birth {getSortIndicator('dob')}
                                </th>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase cursor-pointer" onClick={() => handleSort('contact')}>
                                    Contact {getSortIndicator('contact')}
                                </th>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase cursor-pointer" onClick={() => handleSort('address')}>
                                    Address {getSortIndicator('address')}
                                </th>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase cursor-pointer" onClick={() => handleSort('allergies')}>
                                    Allergies {getSortIndicator('allergies')}
                                </th>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase cursor-pointer" onClick={() => handleSort('medicalConditions')}>
                                    Med. Cond. {getSortIndicator('medicalConditions')}
                                </th>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {sortedAndFilteredPatients.map((patient) => (
                                <tr key={patient.id} className="border-b border-gray-200 hover:bg-gray-50">
                                    <td className="py-3 px-4 text-gray-800">{patient.name}</td>
                                    <td className="py-3 px-4 text-gray-800">{patient.dob}</td>
                                    <td className="py-3 px-4 text-gray-800">{patient.contact}</td>
                                    <td className="py-3 px-4 text-gray-800">{patient.address}</td>
                                    <td className="py-3 px-4 text-gray-800">{patient.allergies}</td>
                                    <td className="py-3 px-4 text-gray-800">{patient.medicalConditions}</td>
                                    <td className="py-3 px-4 flex space-x-2">
                                        <button
                                            onClick={() => handleEdit(patient)}
                                            className="bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600 transition duration-200"
                                        >
                                            Edit
                                        </button>
                                        <button
                                            onClick={() => handleDelete(patient.id)}
                                            className="bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600 transition duration-200"
                                        >
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
        </div>
    );
};

// --- Prescription Management Component ---
const PrescriptionManagement = () => {
    const { db, userId, showMessage, showConfirm } = useFirebase();
    const [prescriptions, setPrescriptions] = useState([]);
    const [patients, setPatients] = useState([]);
    const [medications, setMedications] = useState([]);
    const [formData, setFormData] = useState({
        patientId: '', medicationId: '', quantity: '', status: 'Pending'
    });
    const [editId, setEditId] = useState(null);
    const [searchTerm, setSearchTerm] = useState('');
    const [sortConfig, setSortConfig] = useState({ key: null, direction: 'ascending' });

    useEffect(() => {
        if (!db || !userId) return;

        // Fetch prescriptions
        const rxCollectionRef = collection(db, `artifacts/${userId}/users/${userId}/prescriptions`);
        const unsubscribeRx = onSnapshot(rxCollectionRef, async (snapshot) => {
            const rxData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Enrich prescriptions with patient and medication names
            const enrichedRx = await Promise.all(rxData.map(async (rx) => {
                let patientName = 'Unknown Patient';
                let medicationName = 'Unknown Medication';
                let medicationPrice = 0; // Initialize price

                if (rx.patientId) {
                    const patientDocRef = doc(db, `artifacts/${userId}/users/${userId}/patients`, rx.patientId);
                    const patientSnap = await getDoc(patientDocRef);
                    if (patientSnap.exists()) {
                        patientName = patientSnap.data().name;
                    }
                }

                if (rx.medicationId) {
                    const medDocRef = doc(db, `artifacts/${userId}/users/${userId}/medications`, rx.medicationId);
                    const medSnap = await getDoc(medDocRef);
                    if (medSnap.exists()) {
                        medicationName = medSnap.data().name;
                        medicationPrice = medSnap.data().price || 0;
                    }
                }
                return { ...rx, patientName, medicationName, medicationPrice }; // Pass medicationPrice for billing
            }));
            setPrescriptions(enrichedRx);
        }, (error) => {
            console.error("Error fetching prescriptions:", error);
            showMessage(`Error fetching prescriptions: ${error.message}`, 'error');
        });

        // Fetch patients for dropdown
        const patientCollectionRef = collection(db, `artifacts/${userId}/users/${userId}/patients`);
        const unsubscribePatients = onSnapshot(patientCollectionRef, (snapshot) => {
            const patientsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setPatients(patientsData);
        }, (error) => console.error("Error fetching patients for dropdown:", error));

        // Fetch medications for dropdown
        const medsCollectionRef = collection(db, `artifacts/${userId}/users/${userId}/medications`);
        const unsubscribeMeds = onSnapshot(medsCollectionRef, (snapshot) => {
            const medsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setMedications(medsData);
        }, (error) => console.error("Error fetching medications for dropdown:", error));

        return () => {
            unsubscribeRx();
            unsubscribePatients();
            unsubscribeMeds();
        };
    }, [db, userId, showMessage]);

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData({ ...formData, [name]: value });
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!db || !userId) {
            showMessage("Database not ready. Please try again.", 'error');
            return;
        }

        try {
            const rxCollectionRef = collection(db, `artifacts/${userId}/users/${userId}/prescriptions`);
            if (editId) {
                const rxDocRef = doc(db, rxCollectionRef.path, editId);
                await updateDoc(rxDocRef, {
                    ...formData,
                    quantity: parseInt(formData.quantity, 10),
                });
                showMessage("Prescription updated successfully!", 'success');
            } else {
                await addDoc(rxCollectionRef, {
                    ...formData,
                    quantity: parseInt(formData.quantity, 10),
                    createdAt: new Date(),
                });
                showMessage("Prescription added successfully!", 'success');
            }
            setFormData({ patientId: '', medicationId: '', quantity: '', status: 'Pending' });
            setEditId(null);
        } catch (error) {
            console.error("Error saving prescription:", error);
            showMessage(`Error saving prescription: ${error.message}`, 'error');
        }
    };

    const handleEdit = (rx) => {
        setFormData({
            patientId: rx.patientId,
            medicationId: rx.medicationId,
            quantity: String(rx.quantity),
            status: rx.status,
        });
        setEditId(rx.id);
    };

    const handleDelete = async (id) => {
        if (!db || !userId) return;
        showConfirm(
            "Confirm Delete",
            "Are you sure you want to delete this prescription? This action cannot be undone.",
            async () => {
                try {
                    const rxDocRef = doc(db, `artifacts/${userId}/users/${userId}/prescriptions`, id);
                    await deleteDoc(rxDocRef);
                    showMessage("Prescription deleted successfully!", 'success');
                } catch (error) {
                    console.error("Error deleting prescription:", error);
                    showMessage(`Error deleting prescription: ${error.message}`, 'error');
                }
            }
        );
    };

    const handleDispense = async (prescription) => {
        if (!db || !userId) return;
        if (prescription.status === 'Filled' || prescription.status === 'Picked Up') {
            showMessage("This prescription has already been filled or picked up.", 'info');
            return;
        }

        showConfirm(
            "Confirm Dispense",
            `Are you sure you want to dispense ${prescription.quantity} units of ${prescription.medicationName} for ${prescription.patientName}? This will update inventory and create a bill.`,
            async () => {
                try {
                    const medDocRef = doc(db, `artifacts/${userId}/users/${userId}/medications`, prescription.medicationId);
                    const medSnap = await getDoc(medDocRef);

                    if (!medSnap.exists()) {
                        showMessage("Medication not found in inventory!", 'error');
                        return;
                    }

                    const currentStock = medSnap.data().stock;
                    if (currentStock < prescription.quantity) {
                        showMessage(`Insufficient stock for ${prescription.medicationName}. Only ${currentStock} units available.`, 'error');
                        return;
                    }

                    // 1. Update medication stock
                    await updateDoc(medDocRef, {
                        stock: currentStock - prescription.quantity,
                    });

                    // 2. Update prescription status
                    const rxDocRef = doc(db, `artifacts/${userId}/users/${userId}/prescriptions`, prescription.id);
                    await updateDoc(rxDocRef, {
                        status: 'Filled',
                        filledAt: new Date(),
                    });

                    // 3. Create a billing entry
                    const transactionsCollectionRef = collection(db, `artifacts/${userId}/users/${userId}/transactions`);
                    const amountDue = prescription.quantity * (prescription.medicationPrice || 0);

                    await addDoc(transactionsCollectionRef, {
                        prescriptionId: prescription.id,
                        patientId: prescription.patientId,
                        medicationId: prescription.medicationId,
                        medicationName: prescription.medicationName,
                        patientName: prescription.patientName,
                        amountDue: amountDue,
                        amountPaid: 0,
                        balance: amountDue,
                        transactionDate: new Date(),
                        status: 'Unpaid' // Initial billing status
                    });

                    showMessage(`Prescription for ${prescription.medicationName} (${prescription.quantity} units) filled successfully! Stock updated and bill created.`, 'success');
                } catch (error) {
                    console.error("Error dispensing prescription:", error);
                    showMessage(`Error dispensing prescription: ${error.message}`, 'error');
                }
            }
        );
    };

    const handlePickup = async (prescription) => {
        if (!db || !userId) return;
        if (prescription.status === 'Picked Up') {
            showMessage("This prescription has already been picked up.", 'info');
            return;
        }
        if (prescription.status !== 'Filled') {
            showMessage("This prescription must be filled before it can be picked up.", 'info');
            return;
        }

        // Check if there's an associated bill with a positive balance
        const transactionsRef = collection(db, `artifacts/${userId}/users/${userId}/transactions`);
        const q = query(transactionsRef, where('prescriptionId', '==', prescription.id), where('balance', '>', 0));
        const querySnapshot = await getDocs(q);

        if (!querySnapshot.empty) {
            // Found unpaid bills for this prescription
            showMessage("This prescription has an outstanding balance. Please collect payment before marking as picked up.", 'error');
            return;
        }


        showConfirm(
            "Confirm Pickup",
            `Has ${prescription.patientName} picked up the prescription for ${prescription.medicationName}?`,
            async () => {
                try {
                    const rxDocRef = doc(db, `artifacts/${userId}/users/${userId}/prescriptions`, prescription.id);
                    await updateDoc(rxDocRef, {
                        status: 'Picked Up',
                        pickedUpAt: new Date(),
                    });
                    showMessage(`Prescription for ${prescription.medicationName} picked up successfully!`, 'success');
                } catch (error) {
                    console.error("Error marking prescription as picked up:", error);
                    showMessage(`Error marking prescription as picked up: ${error.message}`, 'error');
                }
            }
        );
    };

    const handleSort = (key) => {
        let direction = 'ascending';
        if (sortConfig.key === key && sortConfig.direction === 'ascending') {
            direction = 'descending';
        } else if (sortConfig.key === key && sortConfig.direction === 'descending') {
            direction = null; // No sort
            key = null;
        }
        setSortConfig({ key, direction });
    };

    const sortedAndFilteredPrescriptions = [...prescriptions]
        .filter(rx =>
            (rx.patientName || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (rx.medicationName || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (rx.status || '').toLowerCase().includes(searchTerm.toLowerCase())
        )
        .sort((a, b) => {
            if (sortConfig.key) {
                const aValue = a[sortConfig.key];
                const bValue = b[sortConfig.key];

                if (aValue === undefined || bValue === undefined || aValue === null || bValue === null) return 0;

                if (typeof aValue === 'string' && typeof bValue === 'string') {
                    return sortConfig.direction === 'ascending'
                        ? aValue.localeCompare(bValue)
                        : bValue.localeCompare(aValue);
                } else {
                    return sortConfig.direction === 'ascending'
                        ? aValue - bValue
                        : bValue - aValue;
                }
            }
            return 0;
        });

    const getSortIndicator = (key) => {
        if (sortConfig.key !== key) return '';
        return sortConfig.direction === 'ascending' ? ' ‚ñ≤' : ' ‚ñº';
    };


    return (
        <div className="bg-white p-8 rounded-xl shadow-lg">
            <h2 className="text-3xl font-bold text-indigo-700 mb-6 border-b-2 border-indigo-200 pb-2">üìù Prescription Management</h2>

            <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8 p-6 bg-indigo-50 rounded-lg shadow-inner">
                <div className="flex flex-col">
                    <label htmlFor="patientSelect" className="text-gray-700 font-medium mb-1">Select Patient:</label>
                    <select
                        id="patientSelect" name="patientId"
                        value={formData.patientId} onChange={handleChange}
                        className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400"
                        required
                    >
                        <option value="">-- Select a Patient --</option>
                        {patients.map(patient => (
                            <option key={patient.id} value={patient.id}>{patient.name}</option>
                        ))}
                    </select>
                </div>
                <div className="flex flex-col">
                    <label htmlFor="medicationSelect" className="text-gray-700 font-medium mb-1">Select Medication:</label>
                    <select
                        id="medicationSelect" name="medicationId"
                        value={formData.medicationId} onChange={handleChange}
                        className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400"
                        required
                    >
                        <option value="">-- Select a Medication --</option>
                        {medications.map(med => (
                            <option key={med.id} value={med.id}>{med.name} ({med.strength})</option>
                        ))}
                    </select>
                </div>
                <div className="flex flex-col">
                    <label htmlFor="quantity" className="text-gray-700 font-medium mb-1">Quantity:</label>
                    <input
                        type="number" id="quantity" name="quantity"
                        value={formData.quantity} onChange={handleChange}
                        className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400"
                        placeholder="e.g., 30" min="1" required
                    />
                </div>
                <div className="flex flex-col">
                    <label htmlFor="status" className="text-gray-700 font-medium mb-1">Status:</label>
                    <select
                        id="status" name="status"
                        value={formData.status} onChange={handleChange}
                        className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400"
                        required
                    >
                        <option value="Pending">Pending</option>
                        <option value="Filled">Filled</option>
                        <option value="Picked Up">Picked Up</option>
                    </select>
                </div>
                <div className="col-span-full flex justify-end mt-4">
                    <button
                        type="submit"
                        className="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-indigo-700 transition duration-300 transform hover:scale-105"
                    >
                        {editId ? 'Update Prescription' : 'Add Prescription'}
                    </button>
                    {editId && (
                        <button
                            type="button"
                            onClick={() => { setEditId(null); setFormData({ patientId: '', medicationId: '', quantity: '', status: 'Pending' }); }}
                            className="ml-4 bg-gray-400 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-gray-500 transition duration-300 transform hover:scale-105"
                        >
                            Cancel Edit
                        </button>
                    )}
                </div>
            </form>

            <h3 className="text-2xl font-semibold text-indigo-600 mb-4">Current Prescriptions</h3>
            <div className="mb-4">
                <input
                    type="text"
                    placeholder="Search prescriptions..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="p-2 border border-gray-300 rounded-lg w-full md:w-1/2 focus:outline-none focus:ring-2 focus:ring-indigo-400"
                />
            </div>
            {prescriptions.length === 0 ? (
                <p className="text-gray-600">No prescriptions added yet. Add some above!</p>
            ) : (
                <div className="overflow-x-auto rounded-lg shadow-md border border-gray-200">
                    <table className="min-w-full bg-white">
                        <thead className="bg-gray-100 border-b border-gray-200">
                            <tr>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase cursor-pointer" onClick={() => handleSort('patientName')}>
                                    Patient {getSortIndicator('patientName')}
                                </th>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase cursor-pointer" onClick={() => handleSort('medicationName')}>
                                    Medication {getSortIndicator('medicationName')}
                                </th>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase cursor-pointer" onClick={() => handleSort('quantity')}>
                                    Quantity {getSortIndicator('quantity')}
                                </th>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase cursor-pointer" onClick={() => handleSort('status')}>
                                    Status {getSortIndicator('status')}
                                </th>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {sortedAndFilteredPrescriptions.map((rx) => (
                                <tr key={rx.id} className="border-b border-gray-200 hover:bg-gray-50">
                                    <td className="py-3 px-4 text-gray-800">{rx.patientName}</td>
                                    <td className="py-3 px-4 text-gray-800">{rx.medicationName}</td>
                                    <td className="py-3 px-4 text-gray-800">{rx.quantity}</td>
                                    <td className="py-3 px-4 text-gray-800">
                                        <span className={`px-2 py-1 rounded-full text-xs font-semibold
                                            ${rx.status === 'Pending' ? 'bg-yellow-100 text-yellow-800' :
                                              rx.status === 'Filled' ? 'bg-blue-100 text-blue-800' :
                                              'bg-green-100 text-green-800'}`}>
                                            {rx.status}
                                        </span>
                                    </td>
                                    <td className="py-3 px-4 flex space-x-2">
                                        <button
                                            onClick={() => handleEdit(rx)}
                                            className="bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600 transition duration-200"
                                        >
                                            Edit
                                        </button>
                                        <button
                                            onClick={() => handleDelete(rx.id)}
                                            className="bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600 transition duration-200"
                                        >
                                            Delete
                                        </button>
                                        <button
                                            onClick={() => handleDispense(rx)}
                                            className="bg-purple-500 text-white px-3 py-1 rounded-md text-sm hover:bg-purple-600 transition duration-200"
                                            disabled={rx.status === 'Filled' || rx.status === 'Picked Up'}
                                        >
                                            Dispense
                                        </button>
                                        <button
                                            onClick={() => handlePickup(rx)}
                                            className="bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600 transition duration-200"
                                            disabled={rx.status !== 'Filled'}
                                        >
                                            Pick Up
                                        </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
        </div>
    );
};


// --- Billing and Payments Component ---
const BillingAndPayments = () => {
    const { db, userId, showMessage, showConfirm } = useFirebase();
    const [transactions, setTransactions] = useState([]);
    const [formData, setFormData] = useState({
        transactionId: '', amountPaid: '', paymentMethod: ''
    });
    const [selectedTransaction, setSelectedTransaction] = useState(null); // To hold the transaction being paid
    const [searchTerm, setSearchTerm] = useState('');
    const [sortConfig, setSortConfig] = useState({ key: null, direction: 'ascending' });

    useEffect(() => {
        if (!db || !userId) return;

        const transactionsCollectionRef = collection(db, `artifacts/${userId}/users/${userId}/transactions`);
        const unsubscribe = onSnapshot(transactionsCollectionRef, async (snapshot) => {
            const txData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Enrich transactions with patient and medication details if needed for display
            const enrichedTx = await Promise.all(txData.map(async (tx) => {
                let patientName = tx.patientName || 'N/A';
                let medicationName = tx.medicationName || 'N/A';

                // If patientName or medicationName is missing in transaction, fetch from linked prescription/patient/medication
                if (!tx.patientName && tx.patientId) {
                    const patientDocRef = doc(db, `artifacts/${userId}/users/${userId}/patients`, tx.patientId);
                    const patientSnap = await getDoc(patientDocRef);
                    if (patientSnap.exists()) {
                        patientName = patientSnap.data().name;
                    }
                }
                if (!tx.medicationName && tx.medicationId) {
                    const medDocRef = doc(db, `artifacts/${userId}/users/${userId}/medications`, tx.medicationId);
                    const medSnap = await getDoc(medDocRef);
                    if (medSnap.exists()) {
                        medicationName = medSnap.data().name;
                    }
                }
                return { ...tx, patientName, medicationName };
            }));
            setTransactions(enrichedTx);
        }, (error) => {
            console.error("Error fetching transactions:", error);
            showMessage(`Error fetching transactions: ${error.message}`, 'error');
        });

        return () => unsubscribe();
    }, [db, userId, showMessage]);

    const handlePayClick = (transaction) => {
        setSelectedTransaction(transaction);
        setFormData({
            transactionId: transaction.id,
            amountPaid: '', // Clear previous amount for new payment
            paymentMethod: ''
        });
    };

    const handlePaymentChange = (e) => {
        const { name, value } = e.target;
        setFormData({ ...formData, [name]: value });
    };

    const handleProcessPayment = async (e) => {
        e.preventDefault();
        if (!db || !userId || !selectedTransaction) {
            showMessage("Payment processing error: System not ready or no transaction selected.", 'error');
            return;
        }

        const paymentAmount = parseFloat(formData.amountPaid);
        if (isNaN(paymentAmount) || paymentAmount <= 0) {
            showMessage("Please enter a valid payment amount.", 'error');
            return;
        }

        const newAmountPaid = (selectedTransaction.amountPaid || 0) + paymentAmount;
        const newBalance = selectedTransaction.amountDue - newAmountPaid;

        if (newBalance < 0) {
            showMessage("Payment amount exceeds the outstanding balance. Please enter a lower amount.", 'error');
            return;
        }

        showConfirm(
            "Confirm Payment",
            `Process $${paymentAmount.toFixed(2)} payment for Bill ID: ${selectedTransaction.id.substring(0,8)}...?`,
            async () => {
                try {
                    const transactionDocRef = doc(db, `artifacts/${userId}/users/${userId}/transactions`, selectedTransaction.id);
                    await updateDoc(transactionDocRef, {
                        amountPaid: newAmountPaid,
                        balance: newBalance,
                        paymentMethod: formData.paymentMethod,
                        status: newBalance <= 0 ? 'Paid' : 'Partially Paid',
                        lastPaymentDate: new Date()
                    });
                    showMessage("Payment processed successfully!", 'success');
                    setSelectedTransaction(null); // Clear selected transaction
                    setFormData({ transactionId: '', amountPaid: '', paymentMethod: '' });
                } catch (error) {
                    console.error("Error processing payment:", error);
                    showMessage(`Error processing payment: ${error.message}`, 'error');
                }
            }
        );
    };

    const handleCancelPayment = () => {
        setSelectedTransaction(null);
        setFormData({ transactionId: '', amountPaid: '', paymentMethod: '' });
    };

    const handleSort = (key) => {
        let direction = 'ascending';
        if (sortConfig.key === key && sortConfig.direction === 'ascending') {
            direction = 'descending';
        } else if (sortConfig.key === key && sortConfig.direction === 'descending') {
            direction = null; // No sort
            key = null;
        }
        setSortConfig({ key, direction });
    };

    const sortedAndFilteredTransactions = [...transactions]
        .filter(tx =>
            (tx.patientName || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (tx.medicationName || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (tx.status || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            tx.id.toLowerCase().includes(searchTerm.toLowerCase())
        )
        .sort((a, b) => {
            if (sortConfig.key) {
                const aValue = a[sortConfig.key];
                const bValue = b[sortConfig.key];

                if (aValue === undefined || bValue === undefined || aValue === null || bValue === null) return 0;

                if (typeof aValue === 'string' && typeof bValue === 'string') {
                    return sortConfig.direction === 'ascending'
                        ? aValue.localeCompare(bValue)
                        : bValue.localeCompare(aValue);
                } else {
                    return sortConfig.direction === 'ascending'
                        ? aValue - bValue
                        : bValue - aValue;
                }
            }
            return 0;
        });

    const getSortIndicator = (key) => {
        if (sortConfig.key !== key) return '';
        return sortConfig.direction === 'ascending' ? ' ‚ñ≤' : ' ‚ñº';
    };


    return (
        <div className="bg-white p-8 rounded-xl shadow-lg">
            <h2 className="text-3xl font-bold text-indigo-700 mb-6 border-b-2 border-indigo-200 pb-2">üí∏ Billing & Payments</h2>

            {selectedTransaction && (
                <form onSubmit={handleProcessPayment} className="bg-green-50 p-6 rounded-lg shadow-inner mb-8 border-l-4 border-green-500">
                    <h3 className="text-xl font-semibold text-green-700 mb-4">Process Payment for Bill ID: {selectedTransaction.id.substring(0,8)}...</h3>
                    <p className="text-gray-700 mb-2">Patient: <span className="font-semibold">{selectedTransaction.patientName}</span></p>
                    <p className="text-gray-700 mb-2">Medication: <span className="font-semibold">{selectedTransaction.medicationName}</span></p>
                    <p className="text-gray-700 mb-4">Amount Due: <span className="font-semibold">${selectedTransaction.amountDue.toFixed(2)}</span> | Balance: <span className="font-semibold text-red-600">${selectedTransaction.balance.toFixed(2)}</span></p>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="flex flex-col">
                            <label htmlFor="amountPaid" className="text-gray-700 font-medium mb-1">Amount to Pay ($):</label>
                            <input
                                type="number" id="amountPaid" name="amountPaid"
                                value={formData.amountPaid} onChange={handlePaymentChange}
                                className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400"
                                placeholder="e.g., 25.50" step="0.01" min="0.01" max={selectedTransaction.balance} required
                            />
                        </div>
                        <div className="flex flex-col">
                            <label htmlFor="paymentMethod" className="text-gray-700 font-medium mb-1">Payment Method:</label>
                            <select
                                id="paymentMethod" name="paymentMethod"
                                value={formData.paymentMethod} onChange={handlePaymentChange}
                                className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400"
                                required
                            >
                                <option value="">-- Select Method --</option>
                                <option value="Cash">Cash</option>
                                <option value="Credit Card">Credit Card</option>
                                <option value="Insurance">Insurance</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div className="flex justify-end space-x-3 mt-6">
                        <button
                            type="button"
                            onClick={handleCancelPayment}
                            className="bg-gray-400 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-gray-500 transition duration-300 transform hover:scale-105"
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            className="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-green-700 transition duration-300 transform hover:scale-105"
                        >
                            Process Payment
                        </button>
                    </div>
                </form>
            )}


            <h3 className="text-2xl font-semibold text-indigo-600 mb-4">All Transactions</h3>
            <div className="mb-4">
                <input
                    type="text"
                    placeholder="Search transactions..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="p-2 border border-gray-300 rounded-lg w-full md:w-1/2 focus:outline-none focus:ring-2 focus:ring-indigo-400"
                />
            </div>
            {transactions.length === 0 ? (
                <p className="text-gray-600">No transactions recorded yet. Dispense a prescription to create a bill!</p>
            ) : (
                <div className="overflow-x-auto rounded-lg shadow-md border border-gray-200">
                    <table className="min-w-full bg-white">
                        <thead className="bg-gray-100 border-b border-gray-200">
                            <tr>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase cursor-pointer" onClick={() => handleSort('id')}>
                                    Bill ID {getSortIndicator('id')}
                                </th>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase cursor-pointer" onClick={() => handleSort('patientName')}>
                                    Patient {getSortIndicator('patientName')}
                                </th>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase cursor-pointer" onClick={() => handleSort('medicationName')}>
                                    Medication {getSortIndicator('medicationName')}
                                </th>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase">
                                    Amount Due
                                </th>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase">
                                    Amount Paid
                                </th>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase cursor-pointer" onClick={() => handleSort('balance')}>
                                    Balance {getSortIndicator('balance')}
                                </th>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase cursor-pointer" onClick={() => handleSort('status')}>
                                    Status {getSortIndicator('status')}
                                </th>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {sortedAndFilteredTransactions.map((tx) => (
                                <tr key={tx.id} className="border-b border-gray-200 hover:bg-gray-50">
                                    <td className="py-3 px-4 text-gray-800">{tx.id.substring(0, 8)}...</td>
                                    <td className="py-3 px-4 text-gray-800">{tx.patientName}</td>
                                    <td className="py-3 px-4 text-gray-800">{tx.medicationName}</td>
                                    <td className="py-3 px-4 text-gray-800">${tx.amountDue ? tx.amountDue.toFixed(2) : '0.00'}</td>
                                    <td className="py-3 px-4 text-gray-800">${tx.amountPaid ? tx.amountPaid.toFixed(2) : '0.00'}</td>
                                    <td className="py-3 px-4 text-gray-800">${tx.balance ? tx.balance.toFixed(2) : '0.00'}</td>
                                    <td className="py-3 px-4 text-gray-800">
                                        <span className={`px-2 py-1 rounded-full text-xs font-semibold
                                            ${tx.status === 'Unpaid' ? 'bg-orange-100 text-orange-800' :
                                              tx.status === 'Partially Paid' ? 'bg-yellow-100 text-yellow-800' :
                                              'bg-green-100 text-green-800'}`}>
                                            {tx.status}
                                        </span>
                                    </td>
                                    <td className="py-3 px-4 flex space-x-2">
                                        <button
                                            onClick={() => handlePayClick(tx)}
                                            className="bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600 transition duration-200"
                                            disabled={tx.balance <= 0} // Disable if fully paid
                                        >
                                            Pay
                                        </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
        </div>
    );
};

// --- New Training Modules Component ---
const TrainingModules = () => {
    const [currentModule, setCurrentModule] = useState('home'); // State to navigate within training modules

    return (
        <div className="bg-white p-8 rounded-xl shadow-lg">
            <h2 className="text-3xl font-bold text-indigo-700 mb-6 border-b-2 border-indigo-200 pb-2">üìö Training Modules</h2>

            {currentModule === 'home' && (
                <div>
                    <p className="text-gray-700 mb-6">Welcome to your Pharmacy Technician Training Hub! Select a module below to begin your practice and study.</p>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <button
                            onClick={() => setCurrentModule('calculations')}
                            className="bg-purple-100 p-6 rounded-lg shadow-md hover:bg-purple-200 transition duration-300 text-purple-800 text-xl font-semibold flex items-center justify-center space-x-3"
                        >
                            <span>üßÆ</span>
                            <span>Calculations</span>
                        </button>
                        <button
                            onClick={() => setCurrentModule('terminology')} // Now active!
                            className="bg-blue-100 p-6 rounded-lg shadow-md hover:bg-blue-200 transition duration-300 text-blue-800 text-xl font-semibold flex items-center justify-center space-x-3"
                        >
                            <span>üìñ</span>
                            <span>Terminology</span>
                        </button>
                        <button
                            // onClick={() => setCurrentModule('pharmacology')} // Future module
                            className="bg-green-100 p-6 rounded-lg shadow-md text-green-800 text-xl font-semibold flex items-center justify-center space-x-3 cursor-not-allowed opacity-60"
                            disabled
                        >
                            <span>üî¨</span>
                            <span>Pharmacology</span>
                        </button>
                        <button
                            // onClick={() => setCurrentModule('lawsRegulations')} // Future module
                            className="bg-red-100 p-6 rounded-lg shadow-md text-red-800 text-xl font-semibold flex items-center justify-center space-x-3 cursor-not-allowed opacity-60"
                            disabled
                        >
                            <span>‚öñÔ∏è</span>
                            <span>Laws & Regulations</span>
                        </button>
                         <button
                            onClick={() => setCurrentModule('quizzes')} // Now active!
                            className="bg-yellow-100 p-6 rounded-lg shadow-md hover:bg-yellow-200 transition duration-300 text-yellow-800 text-xl font-semibold flex items-center justify-center space-x-3"
                        >
                            <span>‚ùì</span>
                            <span>Quizzes</span>
                        </button>
                        <button
                            // onClick={() => setCurrentModule('flashcards')} // Future module
                            className="bg-indigo-100 p-6 rounded-lg shadow-md text-indigo-800 text-xl font-semibold flex items-center justify-center space-x-3 cursor-not-allowed opacity-60"
                            disabled
                        >
                            <span>üß†</span>
                            <span>Flashcards</span>
                        </button>
                    </div>
                </div>
            )}

            {currentModule === 'calculations' && <CalculationsModule onBack={() => setCurrentModule('home')} />}
            {currentModule === 'terminology' && <TerminologyModule onBack={() => setCurrentModule('home')} />}
            {currentModule === 'quizzes' && <QuizzesModule onBack={() => setCurrentModule('home')} />}
            {/* Future modules will go here */}
            {/* {currentModule === 'pharmacology' && <PharmacologyModule onBack={() => setCurrentModule('home')} />} */}
            {/* {currentModule === 'lawsRegulations' && <LawsRegulationsModule onBack={() => setCurrentModule('home')} />} */}
            {/* {currentModule === 'flashcards' && <FlashcardsModule onBack={() => setCurrentModule('home')} />} */}

        </div>
    );
};

// --- Calculations Module Component ---
const CalculationsModule = ({ onBack }) => {
    const [calculationType, setCalculationType] = useState('dosage'); // dosage, concentration
    const [result, setResult] = useState('');
    const [errorMessage, setErrorMessage] = useState('');

    // Dosage Calculation state
    const [desiredDose, setDesiredDose] = useState('');
    const [onHandAmount, setOnHandAmount] = useState('');
    const [onHandVolume, setOnHandVolume] = useState('');

    // Concentration Calculation state
    const [soluteAmount, setSoluteAmount] = useState('');
    const [totalVolume, setTotalVolume] = useState('');

    const handleCalculate = () => {
        setErrorMessage('');
        setResult('');
        if (calculationType === 'dosage') {
            const d = parseFloat(desiredDose);
            const h = parseFloat(onHandAmount);
            const v = parseFloat(onHandVolume);

            if (isNaN(d) || isNaN(h) || isNaN(v) || h === 0) {
                setErrorMessage('Please enter valid numbers for all fields for Dosage Calculation. On Hand Amount cannot be zero.');
                return;
            }
            // Formula: (Desired Dose / On Hand Amount) * On Hand Volume
            const res = (d / h) * v;
            setResult(`Result: ${res.toFixed(3)} units`); // Assuming 'units' could be mL, tablets, etc.
        } else if (calculationType === 'concentration') {
            const s = parseFloat(soluteAmount);
            const v = parseFloat(totalVolume);

            if (isNaN(s) || isNaN(v) || v === 0) {
                setErrorMessage('Please enter valid numbers for all fields for Concentration Calculation. Total Volume cannot be zero.');
                return;
            }
            // Formula: (Solute Amount / Total Volume) * 100 (for percentage)
            const res = (s / v) * 100;
            setResult(`Result: ${res.toFixed(2)} % (w/v)`); // Assuming weight/volume percentage
        }
    };

    const handleReset = () => {
        setDesiredDose('');
        setOnHandAmount('');
        setOnHandVolume('');
        setSoluteAmount('');
        setTotalVolume('');
        setResult('');
        setErrorMessage('');
    };

    return (
        <div className="p-6 bg-white rounded-lg shadow-md">
            <div className="flex justify-between items-center mb-6">
                <h3 className="text-2xl font-bold text-purple-700">üßÆ Calculations Practice</h3>
                <button
                    onClick={onBack}
                    className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400 transition duration-300"
                >
                    Back to Training Home
                </button>
            </div>

            <div className="mb-6">
                <label className="block text-gray-700 font-medium mb-2">Select Calculation Type:</label>
                <select
                    value={calculationType}
                    onChange={(e) => { setCalculationType(e.target.value); handleReset(); }}
                    className="p-2 border border-gray-300 rounded-lg w-full md:w-1/2 focus:outline-none focus:ring-2 focus:ring-purple-400"
                >
                    <option value="dosage">Dosage Calculation (D/H x V)</option>
                    <option value="concentration">Concentration Calculation (% w/v)</option>
                </select>
            </div>

            {calculationType === 'dosage' && (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-purple-50 p-6 rounded-lg shadow-inner mb-6">
                    <div className="flex flex-col">
                        <label htmlFor="desiredDose" className="text-gray-700 font-medium mb-1">Desired Dose (D):</label>
                        <input
                            type="number" id="desiredDose"
                            value={desiredDose} onChange={(e) => setDesiredDose(e.target.value)}
                            className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400"
                            placeholder="e.g., 250 (mg)" step="0.01"
                        />
                    </div>
                    <div className="flex flex-col">
                        <label htmlFor="onHandAmount" className="text-gray-700 font-medium mb-1">On Hand Amount (H):</label>
                        <input
                            type="number" id="onHandAmount"
                            value={onHandAmount} onChange={(e) => setOnHandAmount(e.target.value)}
                            className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400"
                            placeholder="e.g., 500 (mg)" step="0.01"
                        />
                    </div>
                    <div className="flex flex-col">
                        <label htmlFor="onHandVolume" className="text-gray-700 font-medium mb-1">On Hand Volume (V) or Quantity:</label>
                        <input
                            type="number" id="onHandVolume"
                            value={onHandVolume} onChange={(e) => setOnHandVolume(e.target.value)}
                            className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400"
                            placeholder="e.g., 10 (mL or tablets)" step="0.01"
                        />
                    </div>
                </div>
            )}

            {calculationType === 'concentration' && (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-purple-50 p-6 rounded-lg shadow-inner mb-6">
                    <div className="flex flex-col">
                        <label htmlFor="soluteAmount" className="text-gray-700 font-medium mb-1">Solute Amount (grams):</label>
                        <input
                            type="number" id="soluteAmount"
                            value={soluteAmount} onChange={(e) => setSoluteAmount(e.target.value)}
                            className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400"
                            placeholder="e.g., 5 (grams)" step="0.01"
                        />
                    </div>
                    <div className="flex flex-col">
                        <label htmlFor="totalVolume" className="text-gray-700 font-medium mb-1">Total Volume (mL):</label>
                        <input
                            type="number" id="totalVolume"
                            value={totalVolume} onChange={(e) => setTotalVolume(e.target.value)}
                            className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400"
                            placeholder="e.g., 100 (mL)" step="0.01"
                        />
                    </div>
                </div>
            )}

            <div className="flex space-x-4 mb-4">
                <button
                    onClick={handleCalculate}
                    className="bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-purple-700 transition duration-300 transform hover:scale-105"
                >
                    Calculate
                </button>
                <button
                    onClick={handleReset}
                    className="bg-gray-400 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-gray-500 transition duration-300 transform hover:scale-105"
                >
                    Reset
                </button>
            </div>

            {errorMessage && (
                <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mt-4" role="alert">
                    <strong className="font-bold">Error!</strong>
                    <span className="block sm:inline"> {errorMessage}</span>
                </div>
            )}

            {result && (
                <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mt-4" role="alert">
                    <strong className="font-bold">Calculation Result:</strong>
                    <span className="block sm:inline"> {result}</span>
                </div>
            )}
        </div>
    );
};

// --- Terminology Module Component ---
const TerminologyModule = ({ onBack }) => {
    const { db, userId, showMessage } = useFirebase();
    const [terms, setTerms] = useState([]);
    const [formData, setFormData] = useState({ term: '', definition: '' });
    const [searchTerm, setSearchTerm] = useState('');

    useEffect(() => {
        if (!db || !userId) return;
        const termsCollectionRef = collection(db, `artifacts/${userId}/users/${userId}/terminology`);
        const unsubscribe = onSnapshot(termsCollectionRef, (snapshot) => {
            const termsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setTerms(termsData);
        }, (error) => {
            console.error("Error fetching terms:", error);
            showMessage(`Error fetching terms: ${error.message}`, 'error');
        });
        return () => unsubscribe();
    }, [db, userId, showMessage]);

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData({ ...formData, [name]: value });
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!db || !userId) {
            showMessage("Database not ready.", 'error');
            return;
        }
        if (!formData.term.trim() || !formData.definition.trim()) {
            showMessage("Term and Definition cannot be empty.", 'error');
            return;
        }

        try {
            await addDoc(collection(db, `artifacts/${userId}/users/${userId}/terminology`), {
                term: formData.term,
                definition: formData.definition,
                createdAt: new Date(),
            });
            showMessage("Term added successfully!", 'success');
            setFormData({ term: '', definition: '' });
        } catch (error) {
            console.error("Error adding term:", error);
            showMessage(`Error adding term: ${error.message}`, 'error');
        }
    };

    const handleDelete = async (id) => {
        if (!db || !userId) return;
        if (!window.confirm("Are you sure you want to delete this term?")) return;
        try {
            await deleteDoc(doc(db, `artifacts/${userId}/users/${userId}/terminology`, id));
            showMessage("Term deleted successfully!", 'success');
        } catch (error) {
            console.error("Error deleting term:", error);
            showMessage(`Error deleting term: ${error.message}`, 'error');
        }
    };

    const filteredTerms = terms.filter(item =>
        item.term.toLowerCase().includes(searchTerm.toLowerCase()) ||
        item.definition.toLowerCase().includes(searchTerm.toLowerCase())
    );

    return (
        <div className="p-6 bg-white rounded-lg shadow-md">
            <div className="flex justify-between items-center mb-6">
                <h3 className="text-2xl font-bold text-blue-700">üìñ Terminology Practice</h3>
                <button
                    onClick={onBack}
                    className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400 transition duration-300"
                >
                    Back to Training Home
                </button>
            </div>

            <form onSubmit={handleSubmit} className="bg-blue-50 p-6 rounded-lg shadow-inner mb-8 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="flex flex-col">
                    <label htmlFor="term" className="text-gray-700 font-medium mb-1">Term:</label>
                    <input
                        type="text" id="term" name="term"
                        value={formData.term} onChange={handleChange}
                        className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
                        placeholder="e.g., BID" required
                    />
                </div>
                <div className="flex flex-col">
                    <label htmlFor="definition" className="text-gray-700 font-medium mb-1">Definition:</label>
                    <textarea
                        id="definition" name="definition"
                        value={formData.definition} onChange={handleChange}
                        className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 h-24 resize-y"
                        placeholder="e.g., Twice a day" required
                    ></textarea>
                </div>
                <div className="col-span-full flex justify-end mt-4">
                    <button
                        type="submit"
                        className="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-blue-700 transition duration-300 transform hover:scale-105"
                    >
                        Add Term
                    </button>
                </div>
            </form>

            <h3 className="text-2xl font-semibold text-blue-600 mb-4">Saved Terms</h3>
            <div className="mb-4">
                <input
                    type="text"
                    placeholder="Search terms or definitions..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="p-2 border border-gray-300 rounded-lg w-full md:w-1/2 focus:outline-none focus:ring-2 focus:ring-blue-400"
                />
            </div>
            {terms.length === 0 ? (
                <p className="text-gray-600">No terms saved yet. Add some above!</p>
            ) : (
                <div className="overflow-x-auto rounded-lg shadow-md border border-gray-200">
                    <table className="min-w-full bg-white">
                        <thead className="bg-gray-100 border-b border-gray-200">
                            <tr>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase">Term</th>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase">Definition</th>
                                <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {filteredTerms.map((item) => (
                                <tr key={item.id} className="border-b border-gray-200 hover:bg-gray-50">
                                    <td className="py-3 px-4 text-gray-800 font-medium">{item.term}</td>
                                    <td className="py-3 px-4 text-gray-700">{item.definition}</td>
                                    <td className="py-3 px-4">
                                        <button
                                            onClick={() => handleDelete(item.id)}
                                            className="bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600 transition duration-200"
                                        >
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
        </div>
    );
};

// --- Quizzes Module Component (Basic Framework) ---
const QuizzesModule = ({ onBack }) => {
    const [questions, setQuestions] = useState([
        {
            id: 1,
            question: "What is the abbreviation for 'twice a day'?",
            options: ["QD", "BID", "TID", "QID"],
            answer: "BID"
        },
        {
            id: 2,
            question: "Which dosage form is designed for sublingual administration?",
            options: ["Tablet", "Capsule", "Lozenge", "Syrup"],
            answer: "Lozenge"
        },
        {
            id: 3,
            question: "What does 'PRN' stand for on a prescription?",
            options: ["Every morning", "As needed", "Before meals", "At bedtime"],
            answer: "As needed"
        }
    ]);
    const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
    const [selectedOption, setSelectedOption] = useState(null);
    const [feedback, setFeedback] = useState('');
    const [score, setScore] = useState(0);
    const [quizCompleted, setQuizCompleted] = useState(false);

    const handleOptionSelect = (option) => {
        setSelectedOption(option);
    };

    const handleSubmitAnswer = () => {
        if (selectedOption === questions[currentQuestionIndex].answer) {
            setFeedback("Correct! üéâ");
            setScore(score + 1);
        } else {
            setFeedback(`Incorrect. The correct answer was: ${questions[currentQuestionIndex].answer}`);
        }
    };

    const handleNextQuestion = () => {
        setFeedback('');
        setSelectedOption(null);
        if (currentQuestionIndex < questions.length - 1) {
            setCurrentQuestionIndex(currentQuestionIndex + 1);
        } else {
            setQuizCompleted(true);
        }
    };

    const handleRestartQuiz = () => {
        setCurrentQuestionIndex(0);
        setSelectedOption(null);
        setFeedback('');
        setScore(0);
        setQuizCompleted(false);
    };

    const currentQuestion = questions[currentQuestionIndex];

    return (
        <div className="p-6 bg-white rounded-lg shadow-md">
            <div className="flex justify-between items-center mb-6">
                <h3 className="text-2xl font-bold text-yellow-700">‚ùì Quizzes Practice</h3>
                <button
                    onClick={onBack}
                    className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400 transition duration-300"
                >
                    Back to Training Home
                </button>
            </div>

            {!quizCompleted ? (
                <div className="bg-yellow-50 p-6 rounded-lg shadow-inner mb-6">
                    <p className="text-gray-700 text-lg mb-4 font-semibold">Question {currentQuestionIndex + 1} of {questions.length}:</p>
                    <p className="text-gray-900 text-xl font-bold mb-6">{currentQuestion.question}</p>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        {currentQuestion.options.map((option, index) => (
                            <button
                                key={index}
                                onClick={() => handleOptionSelect(option)}
                                className={`px-4 py-3 rounded-lg text-left font-medium transition duration-200
                                    ${selectedOption === option
                                        ? 'bg-yellow-300 text-yellow-900 border-2 border-yellow-500'
                                        : 'bg-white text-gray-800 border border-gray-300 hover:bg-gray-100'}
                                    ${feedback && selectedOption === option && selectedOption !== currentQuestion.answer
                                        ? 'bg-red-200 border-red-500' // Highlight incorrect selected answer
                                        : ''}
                                    ${feedback && option === currentQuestion.answer
                                        ? 'bg-green-200 border-green-500' // Highlight correct answer
                                        : ''}
                                `}
                                disabled={!!feedback} // Disable options once an answer is submitted
                            >
                                {option}
                            </button>
                        ))}
                    </div>

                    {feedback && (
                        <div className={`mt-4 p-3 rounded-lg ${feedback.includes('Correct') ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                            {feedback}
                        </div>
                    )}

                    <div className="flex justify-end mt-6 space-x-3">
                        {!feedback && ( // Show submit button only if no feedback yet
                            <button
                                onClick={handleSubmitAnswer}
                                className="bg-yellow-600 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-yellow-700 transition duration-300 transform hover:scale-105"
                                disabled={selectedOption === null}
                            >
                                Submit Answer
                            </button>
                        )}
                        {feedback && ( // Show next button after feedback
                            <button
                                onClick={handleNextQuestion}
                                className="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-indigo-700 transition duration-300 transform hover:scale-105"
                            >
                                {currentQuestionIndex < questions.length - 1 ? 'Next Question' : 'Finish Quiz'}
                            </button>
                        )}
                    </div>
                </div>
            ) : (
                <div className="text-center bg-yellow-50 p-8 rounded-lg shadow-inner">
                    <h3 className="text-3xl font-bold text-yellow-800 mb-4">Quiz Completed! üéâ</h3>
                    <p className="text-gray-700 text-xl mb-6">You scored: <span className="font-bold text-yellow-900">{score}</span> out of <span className="font-bold text-yellow-900">{questions.length}</span></p>
                    <button
                        onClick={handleRestartQuiz}
                        className="bg-yellow-600 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-yellow-700 transition duration-300 transform hover:scale-105"
                    >
                        Restart Quiz
                    </button>
                </div>
            )}
        </div>
    );
};


export default App;
